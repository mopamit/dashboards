import React, { useState, useEffect } from 'react';
import { 
  CheckCircle, Circle, BarChart3, Users, Calendar, BookOpen, 
  ArrowLeft, School, Check, X, ChevronDown, ChevronUp, 
  Lightbulb, BrainCircuit, Target, Activity, GraduationCap, Layers,
  Layout, Heart, Star, Compass, UserCheck, MessageCircle, ArrowRight
} from 'lucide-react';

// --- MOCK DATA: Infrastructure ---
const KAHAL_TASKS_INIT = [
  { id: 1, task: "בחירת מקצועות לימוד", completed: true },
  { id: 2, task: "הקצאת מורים (תצא\"מ ומיומנויות)", completed: true },
  { id: 3, task: "מורים בחרו שער לימוד", completed: true },
  { id: 4, task: "ביצוע הכשרה מקדימה למורים", completed: true },
  { id: 5, task: "שיבוץ סדירות ליווי דו-חודשית", completed: false },
  { id: 6, task: "הצגת התפיסה להורים", completed: false },
];

const HQ_TASKS_INIT = [
  { id: 101, task: "שיבוץ מלווים לקח\"ל", completed: true },
  { id: 102, task: "שליחת חומרי לימוד וציוד", completed: false },
];

// --- MOCK DATA: Pedagogy (Cards) ---
const GRADES_DATA = [
  { id: 'z', name: "שכבה ז'", students: 126, teachers: 8, started: 102, startedPct: 81, progress: 12.9, avgGrade: 68, groups: 13, courses: 4 },
  { id: 'h', name: "שכבה ח'", students: 537, teachers: 8, started: 537, startedPct: 100, progress: 1.8, avgGrade: 40, groups: 12, courses: 3 },
  { id: 't', name: "שכבה ט'", students: 116, teachers: 6, started: 64, startedPct: 55, progress: 6.6, avgGrade: 28, groups: 8, courses: 3 },
];

const SUBJECTS_DATA = [
  { id: 1, name: "אנגלית", students: 538, teachers: 4, started: 124, startedPct: 23, progress: 1.8, avgGrade: 70, groups: 9, courses: 12 },
  { id: 2, name: "היסטוריה חמ\"ד", students: 181, teachers: 4, started: 145, startedPct: 80, progress: 19.7, avgGrade: 52, groups: 6, courses: 4 },
  { id: 3, name: "מדעים", students: 101, teachers: 3, started: 69, startedPct: 68, progress: 22.6, avgGrade: 86, groups: 4, courses: 1 },
  { id: 4, name: "תנ\"ך חמ\"ד", students: 285, teachers: 8, started: 197, startedPct: 69, progress: 13.0, avgGrade: 72, groups: 5, courses: 7 },
  { id: 5, name: "תושב\"ע", students: 104, teachers: 4, started: 75, startedPct: 72, progress: 14.6, avgGrade: 89, groups: 4, courses: 1 },
];

// --- MOCK DATA: Skills ---
const SKILLS_DATA = [
  { id: 1, name: "ניהול עצמי (תשפ\"ו)", grade: "שכבה ז'", students: 97, teachers: 1, started: 80, startedPct: 82, progress: 29.3, avgGrade: 85 },
  { id: 2, name: "עבודת צוות", grade: "שכבה ח'", students: 150, teachers: 2, started: 45, startedPct: 30, progress: 12.0, avgGrade: 78 },
  { id: 3, name: "חשיבה יצירתית", grade: "שכבה ט'", students: 110, teachers: 2, started: 100, startedPct: 91, progress: 45.5, avgGrade: 92 },
  { id: 4, name: "תקשורת- העברת מסר", grade: "שכבה ז'", students: 126, teachers: 3, started: 10, startedPct: 8, progress: 2.0, avgGrade: 0 },
];

// --- MOCK DATA: Tzaam ---
const TZAAM_DETAILED = {
  questionnaires: [
    { name: "שאלון 1: תחושת שייכות", completed: 85, target: 100 },
    { name: "שאלון 2: מסוגלות עצמית", completed: 62, target: 100 },
    { name: "שאלון 3: מוטיבציה", completed: 40, target: 100 },
  ],
  mentoring: {
    personal: { planned: 450, executed: 320 },
    group: { planned: 40, executed: 38 }
  }
};

// --- Helper: Card Component matching the image ---
const MetricCard = ({ title, students, teachers, started, startedPct, progress, avgGrade, extraInfo, subTitle, onClick }) => (
  <div 
    onClick={onClick}
    className={`bg-white rounded-xl shadow-sm border border-slate-200 p-5 transition-all relative overflow-hidden ${onClick ? 'cursor-pointer hover:shadow-md hover:border-indigo-300' : ''}`}
  >
    {/* Header */}
    <div className="flex justify-between items-start mb-4">
      <div>
        <h3 className="text-lg font-bold text-slate-800">{title}</h3>
        {subTitle && <span className="text-xs text-slate-500">{subTitle}</span>}
      </div>
      <div className="flex gap-3 text-xs text-slate-500">
        <div className="flex items-center gap-1"><Users size={14}/> {students} תלמידים</div>
        <div className="flex items-center gap-1"><UserCheck size={14}/> {teachers} מורים</div>
      </div>
    </div>

    {/* Big Number - Started */}
    <div className="text-center mb-6">
      <div className="text-4xl font-bold text-emerald-500">{started}</div>
      <div className="text-sm text-slate-500">התחילו ({startedPct}%)</div>
    </div>

    {/* Progress Bars */}
    <div className="space-y-4">
      {/* Progress */}
      <div>
        <div className="flex justify-between text-xs mb-1">
          <span className="text-slate-400">התקדמות ממוצעת:</span>
          <span className="font-bold text-slate-700">{progress}%</span>
        </div>
        <div className="w-full bg-slate-100 rounded-full h-1.5">
          <div className="bg-rose-400 h-1.5 rounded-full" style={{ width: `${progress}%` }}></div>
        </div>
      </div>

      {/* Grade */}
      <div>
        <div className="flex justify-between text-xs mb-1">
          <span className="text-slate-400">ציון ממוצע:</span>
          <span className="font-bold text-slate-700">{avgGrade > 10 ? avgGrade/10 : avgGrade}</span>
        </div>
        <div className="w-full bg-slate-100 rounded-full h-1.5">
          <div className="bg-amber-400 h-1.5 rounded-full" style={{ width: `${avgGrade > 10 ? avgGrade : avgGrade * 10}%` }}></div>
        </div>
      </div>
    </div>

    {/* Footer Info */}
    {extraInfo && (
      <div className="mt-6 pt-4 border-t border-slate-50 text-xs text-slate-400 flex justify-end gap-4">
        {extraInfo}
      </div>
    )}
  </div>
);

export default function App() {
  const [activeTab, setActiveTab] = useState('dashboard'); // 'infrastructure' | 'dashboard'
  const [kahalTasks, setKahalTasks] = useState(KAHAL_TASKS_INIT);
  const [isKahalCompleted, setIsKahalCompleted] = useState(false);

  useEffect(() => {
    const kahalDone = kahalTasks.every(t => t.completed);
    setIsKahalCompleted(kahalDone);
  }, [kahalTasks]);

  const toggleKahalTask = (id) => {
    setKahalTasks(prev => prev.map(task => 
      task.id === id ? { ...task, completed: !task.completed } : task
    ));
  };

  return (
    <div dir="rtl" className="min-h-screen bg-slate-50 font-sans text-slate-800">
      {/* Main Header */}
      <header className="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-30">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="bg-indigo-600 p-2 rounded-lg text-white">
              <School size={24} />
            </div>
            <div>
              <h1 className="text-xl font-bold text-slate-900">מערכת ליווי והטמעה</h1>
              <p className="text-xs text-slate-500">דמו למנהלי קהילות (קח"ל)</p>
            </div>
          </div>
          
          <div className="flex bg-slate-100 p-1 rounded-lg">
            <button
              onClick={() => setActiveTab('infrastructure')}
              className={`px-4 py-2 rounded-md text-sm font-medium transition-all flex items-center gap-2 ${
                activeTab === 'infrastructure' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'
              }`}
            >
              <CheckCircle size={16} />
              <span>תשתיות</span>
            </button>
            <button
              onClick={() => setActiveTab('dashboard')}
              className={`px-4 py-2 rounded-md text-sm font-medium transition-all flex items-center gap-2 ${
                activeTab === 'dashboard' 
                  ? 'bg-white text-indigo-600 shadow-sm' 
                  : 'text-slate-500 hover:text-slate-700'
              }`}
            >
              <BarChart3 size={16} />
              <span>דאשבורד פדגוגי</span>
            </button>
          </div>
        </div>
      </header>

      {/* Main Content Area */}
      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {activeTab === 'infrastructure' && (
          <InfrastructureView 
            kahalTasks={kahalTasks} 
            toggleKahalTask={toggleKahalTask}
            hqTasks={HQ_TASKS_INIT}
            isKahalCompleted={isKahalCompleted}
            onContinue={() => setActiveTab('dashboard')}
          />
        )}

        {activeTab === 'dashboard' && (
          <DashboardContainer />
        )}
      </main>
    </div>
  );
}

// --- Container for the Dashboard Sub-Navigation ---
function DashboardContainer() {
  const [subTab, setSubTab] = useState('overview'); // 'overview' | 'learning' | 'tzaam' | 'skills'

  return (
    <div className="space-y-6">
      {/* Sub Navigation Bar */}
      <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-2 flex overflow-x-auto hide-scrollbar gap-2">
        <NavButton active={subTab === 'overview'} onClick={() => setSubTab('overview')} icon={Layout} label="מבט על" />
        <div className="w-px bg-slate-200 mx-2 my-1"></div>
        <NavButton active={subTab === 'learning'} onClick={() => setSubTab('learning')} icon={BookOpen} label="למידה ופדגוגיה" />
        <NavButton active={subTab === 'tzaam'} onClick={() => setSubTab('tzaam')} icon={Users} label="תצא&quot;מ" />
        <NavButton active={subTab === 'skills'} onClick={() => setSubTab('skills')} icon={BrainCircuit} label="מיומנויות" />
      </div>

      {/* Content Rendering */}
      <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
        {subTab === 'overview' && <OverviewView onNavigate={setSubTab} />}
        {subTab === 'learning' && <PedagogyDeepDive />}
        {subTab === 'tzaam' && <TzaamDeepDive />}
        {subTab === 'skills' && <SkillsDeepDive />}
      </div>
    </div>
  );
}

// --- 1. Overview View ---
function OverviewView({ onNavigate }) {
  return (
    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
      {/* Quick Access Cards */}
      <div onClick={() => onNavigate('learning')} className="cursor-pointer bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md hover:border-indigo-300 transition-all group">
        <div className="flex justify-between items-start mb-4">
          <div className="bg-indigo-50 p-3 rounded-lg text-indigo-600 group-hover:bg-indigo-100 transition-colors">
            <BookOpen size={24} />
          </div>
          <span className="text-2xl font-bold text-slate-800">68%</span>
        </div>
        <h3 className="font-bold text-slate-700 mb-1">למידה במקצועות</h3>
        <p className="text-sm text-slate-500">פעילות בשערים ובמקצועות הליבה</p>
      </div>

      <div onClick={() => onNavigate('tzaam')} className="cursor-pointer bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md hover:border-emerald-300 transition-all group">
        <div className="flex justify-between items-start mb-4">
          <div className="bg-emerald-50 p-3 rounded-lg text-emerald-600 group-hover:bg-emerald-100 transition-colors">
            <Users size={24} />
          </div>
          <span className="text-2xl font-bold text-slate-800">82%</span>
        </div>
        <h3 className="font-bold text-slate-700 mb-1">מדד תצא"מ</h3>
        <p className="text-sm text-slate-500">מענה שאלונים ושיחות מנטור</p>
      </div>

      <div onClick={() => onNavigate('skills')} className="cursor-pointer bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md hover:border-amber-300 transition-all group">
        <div className="flex justify-between items-start mb-4">
          <div className="bg-amber-50 p-3 rounded-lg text-amber-600 group-hover:bg-amber-100 transition-colors">
            <BrainCircuit size={24} />
          </div>
          <span className="text-2xl font-bold text-slate-800">5</span>
        </div>
        <h3 className="font-bold text-slate-700 mb-1">קורסי מיומנויות</h3>
        <p className="text-sm text-slate-500">נלמדים כעת בכלל השכבות</p>
      </div>

      {/* Timeline Placeholder */}
      <div className="md:col-span-3 bg-white p-6 rounded-xl border border-slate-200">
        <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2">
          <Calendar size={20} className="text-slate-400"/> אירועים קרובים
        </h3>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div className="p-3 bg-slate-50 rounded-lg border-r-4 border-indigo-500">
            <div className="text-xs text-slate-500">מרץ</div>
            <div className="font-bold text-slate-700">בקרת שערים</div>
          </div>
          <div className="p-3 bg-slate-50 rounded-lg border-r-4 border-emerald-500">
            <div className="text-xs text-slate-500">מרץ</div>
            <div className="font-bold text-slate-700">שאלון מסוגלות</div>
          </div>
        </div>
      </div>
    </div>
  );
}

// --- 2. Pedagogy Deep Dive ---
function PedagogyDeepDive() {
  const [viewMode, setViewMode] = useState('grades'); // 'grades' | 'subjects'

  return (
    <div className="space-y-12">
      {/* SECTION 1: USAGE DATA (METRICS) */}
      <div className="space-y-6">
        {/* Header & Controls */}
        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
          <div>
            <h2 className="text-2xl font-bold text-slate-900">למידה ופדגוגיה</h2>
            <p className="text-slate-500">מעקב אחר קורסים, הספקים וציונים שוטפים</p>
          </div>
          <div className="bg-slate-100 p-1 rounded-lg flex">
            <button 
              onClick={() => setViewMode('grades')}
              className={`px-3 py-1.5 text-sm font-medium rounded-md transition-all ${viewMode === 'grades' ? 'bg-white text-indigo-700 shadow-sm' : 'text-slate-500'}`}
            >
              תצוגה לפי שכבות
            </button>
            <button 
               onClick={() => setViewMode('subjects')}
              className={`px-3 py-1.5 text-sm font-medium rounded-md transition-all ${viewMode === 'subjects' ? 'bg-white text-indigo-700 shadow-sm' : 'text-slate-500'}`}
            >
              תצוגה לפי מקצועות
            </button>
          </div>
        </div>

        {/* Cards Grid */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {viewMode === 'grades' ? (
            GRADES_DATA.map(grade => (
              <MetricCard 
                key={grade.id}
                title={grade.name}
                students={grade.students}
                teachers={grade.teachers}
                started={grade.started}
                startedPct={grade.startedPct}
                progress={grade.progress}
                avgGrade={grade.avgGrade}
                extraInfo={
                  <>
                    <div className="flex items-center gap-1"><Layers size={14}/> {grade.courses} מקצועות</div>
                    <div className="flex items-center gap-1"><Users size={14}/> {grade.groups} קבוצות</div>
                  </>
                }
              />
            ))
          ) : (
            SUBJECTS_DATA.map(subject => (
              <MetricCard 
                key={subject.id}
                title={subject.name}
                students={subject.students}
                teachers={subject.teachers}
                started={subject.started}
                startedPct={subject.startedPct}
                progress={subject.progress}
                avgGrade={subject.avgGrade}
                extraInfo={
                  <>
                    <div className="flex items-center gap-1"><BookOpen size={14}/> {subject.courses} קורסים</div>
                    <div className="flex items-center gap-1"><Users size={14}/> {subject.groups} קבוצות</div>
                  </>
                }
              />
            ))
          )}
        </div>
      </div>

      {/* SECTION 2: THE WHOLE CHILD */}
      <div className="pt-8 border-t border-slate-200">
         <WholeChildView />
      </div>
    </div>
  );
}

// --- 3. Tzaam Deep Dive ---
function TzaamDeepDive() {
  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
         <div>
          <h2 className="text-2xl font-bold text-slate-900">תמונת מצב תצא"מ</h2>
          <p className="text-slate-500">דיווח מנטורים ומענה שאלונים חברתיים-רגשיים</p>
        </div>
        <button className="text-indigo-600 text-sm font-bold hover:underline">ייצא דוח מפורט</button>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Questionnaires Status */}
        <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
          <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
            <Activity className="text-emerald-500" size={20} />
            סטטוס מענה שאלונים
          </h3>
          <div className="space-y-6">
            {TZAAM_DETAILED.questionnaires.map((q, idx) => (
              <div key={idx}>
                <div className="flex justify-between mb-2">
                  <span className="font-medium text-slate-700">{q.name}</span>
                  <span className="font-bold text-indigo-600">{q.completed}%</span>
                </div>
                <div className="w-full bg-slate-100 rounded-full h-3">
                  <div 
                    className={`h-3 rounded-full ${q.completed > 70 ? 'bg-emerald-500' : q.completed > 40 ? 'bg-amber-400' : 'bg-rose-400'}`} 
                    style={{width: `${q.completed}%`}}
                  ></div>
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Mentoring Status */}
        <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
          <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
            <MessageCircle className="text-indigo-500" size={20} />
            מפגשי מנטור
          </h3>
          <div className="grid grid-cols-2 gap-4">
            <div className="bg-indigo-50 rounded-xl p-4 text-center border border-indigo-100">
              <div className="text-sm text-indigo-700 mb-1 font-bold">מפגשים אישיים</div>
              <div className="text-3xl font-bold text-indigo-900">{TZAAM_DETAILED.mentoring.personal.executed}</div>
              <div className="text-xs text-indigo-400">מתוך {TZAAM_DETAILED.mentoring.personal.planned} מתוכננים</div>
              <div className="mt-2 w-full bg-white h-1.5 rounded-full overflow-hidden">
                <div className="bg-indigo-500 h-full" style={{width: `${(TZAAM_DETAILED.mentoring.personal.executed/TZAAM_DETAILED.mentoring.personal.planned)*100}%`}}></div>
              </div>
            </div>
             <div className="bg-emerald-50 rounded-xl p-4 text-center border border-emerald-100">
              <div className="text-sm text-emerald-700 mb-1 font-bold">מפגשים קבוצתיים</div>
              <div className="text-3xl font-bold text-emerald-900">{TZAAM_DETAILED.mentoring.group.executed}</div>
              <div className="text-xs text-emerald-400">מתוך {TZAAM_DETAILED.mentoring.group.planned} מתוכננים</div>
              <div className="mt-2 w-full bg-white h-1.5 rounded-full overflow-hidden">
                <div className="bg-emerald-500 h-full" style={{width: `${(TZAAM_DETAILED.mentoring.group.executed/TZAAM_DETAILED.mentoring.group.planned)*100}%`}}></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

// --- 4. Skills Deep Dive & Drill Down ---
function SkillsDeepDive() {
  const [selectedSkill, setSelectedSkill] = useState(null);

  return (
    <div className="space-y-6">
      {!selectedSkill ? (
        // LIST VIEW
        <>
          <div>
            <h2 className="text-2xl font-bold text-slate-900">מיומנויות המאה ה-21</h2>
            <p className="text-slate-500">מעקב אחר קורסי מיומנויות פעילים בחלוקה לשכבות. לחץ על כרטיס לפירוט.</p>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {SKILLS_DATA.map((skill) => (
              <MetricCard 
                key={skill.id}
                title={skill.name}
                subTitle={skill.grade}
                students={skill.students}
                teachers={skill.teachers}
                started={skill.started}
                startedPct={skill.startedPct}
                progress={skill.progress}
                avgGrade={skill.avgGrade}
                onClick={() => setSelectedSkill(skill)}
                extraInfo={
                  <div className="flex items-center gap-1 text-amber-600 font-medium">
                    <Target size={14} /> קורס חובה (לחץ לצפייה)
                  </div>
                }
              />
            ))}
          </div>
        </>
      ) : (
        // DETAIL VIEW (Drill Down)
        <div className="animate-in slide-in-from-right-4 duration-300">
           {/* Detail Header */}
           <div className="flex items-center gap-4 mb-8">
             <button 
               onClick={() => setSelectedSkill(null)}
               className="p-2 rounded-full hover:bg-slate-100 border border-transparent hover:border-slate-200 transition-all"
             >
               <ArrowRight size={24} className="text-slate-600" />
             </button>
             <div>
               <h2 className="text-2xl font-bold text-slate-900">{selectedSkill.name}</h2>
               <p className="text-slate-500">{selectedSkill.grade} • {selectedSkill.students} תלמידים רשומים</p>
             </div>
           </div>

           {/* Detail Content (Mock Table) */}
           <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
             <div className="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
               <h3 className="font-bold text-slate-700">רשימת תלמידים בקורס</h3>
               <button className="text-xs font-bold text-indigo-600 hover:underline">ייצוא לאקסל</button>
             </div>
             <div className="overflow-x-auto">
               <table className="w-full text-sm text-right">
                 <thead className="bg-white text-slate-500 border-b border-slate-100">
                   <tr>
                     <th className="px-6 py-3 font-medium">שם התלמיד</th>
                     <th className="px-6 py-3 font-medium">כיתה</th>
                     <th className="px-6 py-3 font-medium">נוכחות</th>
                     <th className="px-6 py-3 font-medium">הגשת מטלות</th>
                     <th className="px-6 py-3 font-medium">ציון נוכחי</th>
                   </tr>
                 </thead>
                 <tbody className="divide-y divide-slate-50">
                   {/* Generating some dummy rows based on selected skill */}
                   {[1, 2, 3, 4, 5].map((i) => (
                     <tr key={i} className="hover:bg-slate-50/50">
                       <td className="px-6 py-3 font-medium text-slate-700">תלמיד {i}</td>
                       <td className="px-6 py-3 text-slate-500">{selectedSkill.grade} - {i}</td>
                       <td className="px-6 py-3">
                         <div className="flex items-center gap-2">
                           <div className="w-16 bg-slate-100 rounded-full h-1.5">
                             <div className="bg-emerald-500 h-1.5 rounded-full" style={{width: `${80 + i*3}%`}}></div>
                           </div>
                           <span className="text-xs">{80 + i*3}%</span>
                         </div>
                       </td>
                       <td className="px-6 py-3 text-slate-600">{i}/5 הוגשו</td>
                       <td className="px-6 py-3 font-bold text-slate-700">{selectedSkill.avgGrade + (i % 2 === 0 ? 5 : -2)}</td>
                     </tr>
                   ))}
                 </tbody>
               </table>
             </div>
             <div className="p-4 bg-slate-50 border-t border-slate-200 text-center text-xs text-slate-400">
               מציג 5 מתוך {selectedSkill.students} תלמידים
             </div>
           </div>
        </div>
      )}
    </div>
  );
}

// --- 5. The Whole Child View (Integrated under Pedagogy) ---
function WholeChildView() {
  const [selectedPillar, setSelectedPillar] = useState(null);

  const pillars = [
    {
      id: 'loves',
      title: 'אוהב ללמוד',
      icon: Heart,
      color: 'rose',
      metric: '84%',
      desc: 'מעורבות רגשית, שייכות ומוטיבציה',
      sections: [
        {
          title: 'הערכה אובייקטיבית',
          items: [
            { label: 'רגש', val: 'חיובי (85%)' },
            { label: 'עניין', val: 'גבוה' },
          ]
        },
        {
          title: 'הערכה סובייקטיבית',
          items: [
             { label: 'הנאה מלמידה', val: '8.4/10' }
          ]
        }
      ]
    },
    {
      id: 'wants',
      title: 'רוצה ללמוד',
      icon: Star,
      color: 'amber',
      metric: '76%',
      desc: 'הצבת יעדים, בחירה וסקרנות',
      sections: [
        {
          title: 'הערכה אובייקטיבית',
          items: [
             { label: 'התמדה', val: '92%' },
             { label: 'מעורבות', val: 'גבוהה' },
             { label: 'איתגור עצמי', val: 'בינוני' }
          ]
        },
        {
          title: 'הערכה סובייקטיבית',
          items: [
             { label: 'מוטיבציה', val: '8.8/10' },
             { label: 'תפיסת מאמץ', val: 'מותאם' }
          ]
        }
      ]
    },
    {
      id: 'knows',
      title: 'יודע ללמוד',
      icon: Compass,
      color: 'indigo',
      metric: '62%',
      desc: 'מיומנויות למיד עצמאית והישגים',
      sections: [
        {
          title: 'הערכה אובייקטיבית',
          items: [
            { label: 'הישגים (ציונים)', val: '82' },
            { label: 'קצב התקדמות', val: 'תקין' }
          ]
        },
        {
          title: 'הערכה סובייקטיבית',
          items: [
             { label: 'מסוגלות עצמית', val: 'גבוהה' }
          ]
        }
      ]
    }
  ];

  return (
    <div className="space-y-8">
      <div className="text-center max-w-2xl mx-auto">
        <h2 className="text-3xl font-bold text-slate-900 mb-2">תמונת הילד השלם</h2>
        <p className="text-slate-500">
          מודל הוליסטי המשלב בין ההיבט הרגשי (אוהב), המוטיבציוני (רוצה) והקוגניטיבי (יודע).
          לחץ על עמודה לצפייה בנתוני עומק.
        </p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-8 px-4">
        {pillars.map((p) => (
          <div 
            key={p.id}
            onClick={() => setSelectedPillar(selectedPillar === p.id ? null : p.id)}
            className={`
              cursor-pointer rounded-2xl p-8 border-2 transition-all duration-300 relative overflow-hidden group
              ${selectedPillar === p.id ? `border-${p.color}-500 bg-${p.color}-50 shadow-xl scale-105` : `border-slate-100 bg-white hover:border-${p.color}-200 hover:shadow-lg`}
            `}
          >
            <div className={`
              absolute top-0 right-0 p-4 rounded-bl-3xl opacity-20
              bg-${p.color}-500
            `}>
              <p.icon size={60} />
            </div>

            <div className="relative z-10">
              <div className={`inline-flex p-3 rounded-xl mb-6 bg-${p.color}-100 text-${p.color}-600`}>
                <p.icon size={32} />
              </div>
              
              <h3 className="text-2xl font-bold text-slate-800 mb-1">{p.title}</h3>
              <p className="text-slate-500 text-sm mb-6 h-10">{p.desc}</p>
              
              <div className="flex items-baseline gap-2 mb-6">
                <span className={`text-5xl font-bold text-${p.color}-500`}>{p.metric}</span>
                <span className="text-slate-400 font-medium">מדד משוקלל</span>
              </div>

              {selectedPillar === p.id && (
                <div className="mt-6 pt-6 border-t border-slate-200 animate-in fade-in slide-in-from-top-2 text-right">
                   {p.sections.map((section, idx) => (
                     <div key={idx} className="mb-4">
                       <h4 className="font-bold text-xs text-slate-400 uppercase mb-2 tracking-wider">{section.title}</h4>
                       <div className="space-y-2">
                         {section.items.map((item, i) => (
                            <div key={i} className="flex justify-between items-center text-sm">
                              <span className="text-slate-600">{item.label}</span>
                              <span className="font-bold text-slate-800">{item.val}</span>
                            </div>
                         ))}
                       </div>
                     </div>
                   ))}
                  <button className={`w-full mt-2 py-2 rounded-lg font-bold text-sm bg-${p.color}-200 text-${p.color}-800 hover:bg-${p.color}-300 transition-colors`}>
                    צפה ברשימת תלמידים
                  </button>
                </div>
              )}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

// --- Helper Components ---

function NavButton({ active, onClick, icon: Icon, label, color }) {
  const activeClass = active 
    ? 'bg-slate-800 text-white shadow-md' 
    : 'bg-transparent text-slate-500 hover:bg-slate-100 hover:text-slate-700';
  
  return (
    <button 
      onClick={onClick}
      className={`
        flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap
        ${activeClass}
        ${color && !active ? color : ''}
      `}
    >
      <Icon size={16} className={color && active ? 'text-rose-300' : ''} />
      <span>{label}</span>
    </button>
  );
}

// --- Infrastructure Component (Kept from previous version for completeness) ---
function TaskItem({ task, onToggle, readOnly = false }) {
  return (
    <div 
      onClick={() => !readOnly && onToggle(task.id)}
      className={`flex items-center gap-4 p-4 rounded-xl border ${task.completed ? 'bg-emerald-50 border-emerald-200' : 'bg-white border-slate-200'} ${!readOnly ? 'cursor-pointer' : ''}`}
    >
      <div className={`w-6 h-6 rounded-full flex items-center justify-center ${task.completed ? 'bg-emerald-500 text-white' : 'bg-slate-100 text-slate-300 border'}`}>
        {task.completed ? <Check size={14} /> : <Circle size={14} />}
      </div>
      <span className={task.completed ? 'text-emerald-900 font-medium' : 'text-slate-700'}>{task.task}</span>
    </div>
  );
}

function InfrastructureView({ kahalTasks, toggleKahalTask, hqTasks, isKahalCompleted, onContinue }) {
  return (
    <div className="space-y-6 animate-in fade-in">
       <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex justify-between items-center">
         <div>
            <h2 className="text-2xl font-bold text-slate-900">צ'ק ליסט: מוכנות לשנה</h2>
            <p className="text-slate-600">השלם את המשימות כדי לפתוח את הדאשבורד</p>
         </div>
         {isKahalCompleted && (
           <button onClick={onContinue} className="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-indigo-700 transition-all flex items-center gap-2">
             עבור לדאשבורד <ArrowLeft size={20}/>
           </button>
         )}
       </div>
       <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div className="space-y-4">
            <h3 className="font-bold text-indigo-900">משימות קח"ל</h3>
            {kahalTasks.map(t => <TaskItem key={t.id} task={t} onToggle={toggleKahalTask} />)}
          </div>
          <div className="space-y-4 opacity-75">
            <h3 className="font-bold text-slate-700">משימות מטה</h3>
            {hqTasks.map(t => <TaskItem key={t.id} task={t} readOnly />)}
          </div>
       </div>
    </div>
  );
}
